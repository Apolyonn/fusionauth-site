---
layout: doc
title: FusionAuth cluster setup
description: FusionAuth cluster setup
---

== Cluster Install

FusionAuth is stateless. Clustering nodes provides increased performance and redundancy. You can run as many FusionAuth nodes as you'd like.

FusionAuth stores almost all state in the database. For clustered enviroments, the following is shared between nodes:

* Cache invalidations
* System log file access

=== Preparation

Before you cluster multiple servers or containers running FusionAuth, you'll want to prepare your environment. In addition to FusionAuth, you'll need the following components:

* A standalone database. This will be used by all nodes to maintain state. While you could run this on one of the FusionAuth nodes, you will generally have better performance on a dedicated server.
* A load balancer in front of the FusionAuth nodes which will distribute traffic between them.

This infrastructure must be created and managed for a functional FusionAuth cluster. However, setting these up so is beyond the scope of this document. Instead, these instructions assume you have a load balancer and database server already configured.

When building a FusionAuth cluster, consider:

* What load balancer will you use? Software or hardware load balancers work equally well. You can use a vendor managed balancer like an AWS ALB or an open source web server such as nginx too. 
* By what algorithm will traffic be distributed? If all the nodes are equivalent, using a round robin algorithm is fine.
* Where will you terminate SSL? Typically this is done at the load balancer, but can be done at the FusionAuth nodes.
* What level of security and network isolation do you need? You can run FusionAuth in a private network and have all HTTP connections proceed through the load balancer, with SSH connections happening through a jump box, for example.
* What version of FusionAuth will you be running? All nodes must be on the same version to function correctly.
* How will you manage link:/docs/v1/tech/reference/configuration/[FusionAuth configuration]? All nodes must have the same configuration or undetermined behavior will occur. How will you ensure that configuration changes are replicated to every node?
* With a standalone database you must use the link:/docs/v1/tech/installation-guide/fusionauth-app/#advanced-installation[advanced database installation] and run the database creation and migration scripts outside of FusionAuth. How will you manage this? Do you have in-house tools to do so?

=== Installation

User the link:/docs/v1/tech/installation-guide/fusionauth-app/#advanced-installation[advanced database installation instructions] to create the FusionAuth database. Add a FusionAuth user and password and note the connection information. You'll want a JDBC URL.

Install FusionAuth on each of the servers or containers which you plan to run. You can install the software on each server via RPM, DEB, zip file or link:/docs/v1/tech/installation-guide/[any of the installation methods]. 

Capture your link:/docs/v1/tech/reference/configuration/[FusionAuth configuration]. Double check the following settings:

* `fusionauth-app.url` should typically be blank. You may need to manually specify this value if you have multiple FusionAuth nodes and the only way the nodes can communicate is on a public network. 
* Set `fusionauth-app.runtime-mode` to `production`. This means that users will never see maintenance mode and you will have to apply database upgrades manually. link:/docs/v1/tech/installation-guide/fusionauth-app/#runtime-modes[More here].
* Configure `database.url` with the full JDBC connection string URL.
* Set `database.username` to the database user FusionAuth should connect as.
* Update `database.password` as the password FusionAuth should connect with.

Distribute configuration to all your nodes. You can do this via environment variables, Java system properties, or by pushing the `fusionauth.properties` file to each server. 

Restart the instances to ensure configuration changes are picked up.

Add the instance addresses to your load balancer. If you are terminating TLS at the load balancer, proxy the http port, otherwise communicate over the TLS port. Both of these are configurable, but they default to 9011 and 9013. 

Configure the load balancer to forward the following headers to FusionAuth:

* `X-Forwarded-Proto`: typically this will be `https`. This ensures any redirect are sent with the appropriate scheme.
* `X-Forwarded-Host`: The original host requested by the client in the Host HTTP request header.
* `X-Forwarded-For`: The originating IP address of the client.
* `X-Forwarded-Server`: The hostname of the proxy server.

You can see community submitted proxy configurations in link:https://github.com/FusionAuth/fusionauth-contrib/tree/master/Reverse%20Proxy%20Configurations[the fusionauth-contrib repo].

=== Verification

Verify that the installation is clustered by navigating to [breadcrumb]#System -> About#. You'll see multiple nodes listed.

Pic TBD

The node you are currently running on is marke by checkmark in the [field]#This node# field.

You may see the incorrect IP addresses for each node. This is link:https://github.com/FusionAuth/fusionauth-issues/issues/1030[an open issue], but doesn't affect functionality at all.

[NOTE.since]
====
Available since 1.16.0-RC1
====

Should you need to review system log files in the administrative user interface, you can see those by navigating to [breadcrumb]#System -> Logs#. You should see logs for all nodes there. 

See link:/docs/v1/tech/troubleshooting/[the Troubleshooting documentation] for more information about logs.

== Cluster Operation

=== Security

While ssh access to the nodes is helpful for initial installation and troubleshooting, you should not need such access during normal operation of the cluster. 

You can also lock down the FusionAuth servers to only accept traffic from the load balancer.

=== Monitoring

If your load balancer supports health checks, call the link:/docs/v1/tech/apis/system#system-status[status API]. A `GET` request against the `/api/status` endpoint will return a status code. It'll either be `200` if the system is operating as expected or non-`200` value if there are any issues with the node.

There's https://github.com/FusionAuth/fusionauth-issues/issues/362[an open issue to add a Prometheus endpoint] but it is not currently supported.

In addition to viewing the log files in the adminstrative user interface as mentioned above, you can also ingest the link:/docs/v1/tech/apis/system/#export-system-logs[system log output], link:/docs/v1/tech/apis/event-logs/[event logs] and link:/docs/v1/tech/apis/audit-logs/#export-audit-logs[audit logs] into a log management system. 

=== Adding and Removing Nodes

To add more nodes, do the following:

* Stand up new FusionAuth servers.
* Configure them in the same way as the existing nodes.
* In particular, provide connection info for the same database. 
* Update your load balancer to send traffic to the new node.

To remove nodes, simply:

* Update your load balancer configuration; remove the node that you'll be shutting down. 
* Stop FusionAuth on the node to be removed.
* Verify that the node disappears from the node list displayed at [breadcrumb]#System -> About#.

=== How Many Instances Should I Run?

To determine the number of nodes to run, you should load test your cluster. Usage, installation and configuration differ across environments and load testing is the best way to determine the correct values for your situation.

You can use any load testing tool you'd like. Alternatively, use https://github.com/FusionAuth/fusionauth-load-tests[the FusionAuth load testing scripts]. 

If you'd like detailed architecture or design guidance, please purchase link:/pricing/[a support contract].

== Cluster Upgrades

To upgrade your cluster, first scheduled a downtime window. During that window: 

* Take down all the nodes.
* Upgrade the database schema by running the migration SQL scripts.
* Upgrade FusionAuth on each node.
* Start all the nodes.

The recommendation is to automate this process using whatever scripting or configuration managment tool is familiar. This will minimize the downtime. 

As a point of reference, for our hosted solutions FusionAuth uses a configuration management tool and typically sees downtime on the order of seconds.
